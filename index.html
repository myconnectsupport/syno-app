<!doctype html>
<html lang="fr">
  <head>
    <meta charset="UTF-8" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover"
    />
    <title>Synoptique Technicien</title>
    <link rel="icon" href="assets/myco.png" />
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdn.sheetjs.com/xlsx-0.20.1/package/dist/xlsx.full.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
    
    <link rel="stylesheet" href="style.css" />
  </head>
  <body>

    <div id="auth-overlay" class="fixed inset-0 flex items-center justify-center overflow-hidden z-[9999]">
      <div class="particles-container" id="particles-container"></div>
      <div class="absolute inset-0 animated-gradient"></div>
      <div class="absolute inset-0 flex items-center justify-center pointer-events-none">
        <img src="assets/myco2.png" class="w-[1050px] max-w-[80%] opacity-10 select-none" />
      </div>

      <div class="relative z-20 text-center text-white px-6">
        <h1 class="text-5xl md:text-6xl font-light tracking-[0.4em] mb-[280px] animate-title">
          MYSYNO
        </h1>
        <div class="flex flex-col gap-6 w-72 mx-auto">
          <input
            type="password"
            id="pass-field"
            maxlength="4"
            placeholder="Code"
            autofocus
            onkeydown="if(event.key === 'Enter') checkPass()"
            class="w-full py-3 rounded-2xl text-center text-white bg-white/10 backdrop-blur-md outline-none transition duration-300 focus:bg-white/20 focus:shadow-[0_0_15px_rgba(255,255,255,0.3)]"
          />
          <button onclick="checkPass()" class="bg-white text-black font-semibold py-3 rounded-2xl transition duration-300 hover:scale-105 active:scale-95">
            VALIDER
          </button>
          <div id="authLoader" class="hidden w-10 h-10 mx-auto border-4 border-white border-t-transparent rounded-full animate-spin"></div>
        </div>
      </div>
    </div>

    <input type="file" id="fileLoader" style="display: none" accept=".json" onchange="loadProject(this)" />
    <input type="file" id="photoInput" style="display: none" accept="image/*" onchange="processPhoto(this)" />

    <div class="header">
      
      <div class="dark-mode-toggle">
        <label class="apple-switch">
          <input type="checkbox" id="darkModeSwitch" onchange="toggleDarkMode()" />
          <span class="slider">
            <i class="bi bi-moon-fill"></i> </span>
        </label>
      </div>

      <div class="apple-status" id="saveStatus">
        <i class="bi bi-cloud-check"></i> <span class="status-text">Enregistr√©</span>
      </div>

      <input
        type="text"
        id="siteName"
        class="apple-input"
        placeholder="Nom du projet"
        oninput="checkInput()"
      />

      <div class="header-actions">
        
        <button class="header-btn" onclick="saveProject()" title="Sauvegarder">
          <i class="bi bi-floppy"></i>
          <span>Sauver</span>
        </button>

        <button class="header-btn" onclick="if(confirm('Cr√©er un nouveau projet vierge ?\n(Pensez √† sauvegarder avant !)')) clearBrowserSave()" title="Nouveau Projet" style="margin-right: auto;">
           <i class="bi bi-file-earmark-plus"></i> <span>Nouveau</span>
        </button>

        <button class="header-btn" onclick="triggerLoad()" title="Ouvrir">
          <i class="bi bi-folder2-open"></i>
          <span>Ouvrir</span>
        </button>

        <button class="header-btn" onclick="openAddModal()" title="Ajouter √©quipement">
          <i class="bi bi-plus-lg"></i>
          <span>Ajouter</span>
        </button>

        <input type="file" id="bgLoader" style="display: none" accept="image/*" onchange="loadBackgroundImage(this)" />
        
        <button class="header-btn" onclick="document.getElementById('bgLoader').click()" title="Ajouter un plan (Google Maps, Architecte...)">
          <i class="bi bi-map"></i>
          <span>Plan</span>
        </button>

        <button class="header-btn" onclick="toggleZoneMode()" title="Dessiner une zone">
          <i class="bi bi-border-style"></i>
          <span class="btn-label">Zone/Espace</span>
        </button>

        <button class="header-btn" id="delZoneBtn" onclick="toggleSelectionMode()" title="Supprimer une zone">
          <i class="bi bi-x-square"></i>
          <span>Zone Suppr.</span>
        </button>

        <button class="header-btn" id="multiSelectBtn" onclick="toggleMultiSelectMode()" title="S√©lectionner plusieurs √©quipements">
          <i class="bi bi-bounding-box-circles"></i>
          <span>Zone S√©lect.</span>
        </button>

        <button class="header-btn" id="penBtn" onclick="togglePenMode()" title="Reconnecter des √©quipements">
          <i class="bi bi-bezier2"></i>
          <span>Liens</span>
        </button>

        <button class="header-btn" id="btnUndo" onclick="undo()" title="Annuler (Ctrl+Z)" disabled style="opacity:0.5;">
            <i class="bi bi-arrow-counterclockwise"></i>
            <span></span>
        </button>

        <button class="header-btn" id="btnRedo" onclick="redo()" title="R√©tablir (Ctrl+Y)" disabled style="opacity:0.5;">
            <i class="bi bi-arrow-clockwise"></i>
            <span></span>
        </button>

        <button class="header-btn" onclick="exportToExcel()" title="Exporter inventaire (.xlsx)">
            <i class="bi bi-file-earmark-spreadsheet"></i>
            <span>Excel</span>
        </button>

        <button class="header-btn disabled" id="btnDownload" onclick="downloadPDF()" title="Exporter en PDF">
          <i class="bi bi-file-earmark-pdf"></i>
          <span>PDF</span>
        </button>

        <button class="header-btn" onclick="toggleHelp()" title="Aide & Raccourcis">
          <i class="bi bi-gear"></i> 
        </button>

      </div>    
    </div>

    <div id="helpModal" class="help-overlay" onclick="closeHelpOnOutsideClick(event)" style="display: none;">
        <div class="help-content">
            <div class="help-header">
                <h2>
                    <i class="bi bi-book" style="margin-right: 8px;"></i> Guide d'utilisation
                </h2>
                <button class="close-btn" onclick="toggleHelp()">‚úï</button>
            </div>
            
            <div class="help-body">
                <h3>Barre d'outils</h3>
                <div class="help-grid">
                    <div class="help-item"><i class="bi bi-floppy"></i> <strong>Sauver :</strong> T√©l√©charge votre projet (.json).</div>
                    <div class="help-item"><i class="bi bi-folder2-open"></i> <strong>Ouvrir :</strong> Charge un ancien projet.</div>
                    <div class="help-item"><i class="bi bi-file-earmark-plus"></i> <strong>Nouveau :</strong> Nettoie l'√©cran (Nouveau projet).</div>
                    <div class="help-item"><i class="bi bi-plus-lg"></i> <strong>Ajouter :</strong> Cr√©er un √©quipement.</div>
                    <div class="help-item"><i class="bi bi-map"></i> <strong>Plan :</strong> Importer un fond de carte/plan. (.img / .jpg)</div>
                    <div class="help-item"><i class="bi bi-border-style"></i> <strong>Zone/Espace :</strong> Dessiner des cadres color√©s.</div>
                    <div class="help-item"><i class="bi bi-x-square"></i> <strong>Zone Suppr :</strong> Carr√© rouge pour effacer en masse.</div>
                    <div class="help-item"><i class="bi bi-bounding-box-circles"></i> <strong>S√©lect :</strong> Carr√© violet pour s√©lectionner en masse.</div>
                    <div class="help-item"><i class="bi bi-bezier2"></i> <strong>Liens :</strong> Forcer un c√¢ble entre 2 objets.</div>
                    <div class="help-item"><i class="bi bi-arrow-counterclockwise"></i> <strong>Historique :</strong> Annuler / R√©tablir une action.</div>
                    <div class="help-item"><i class="bi bi-file-earmark-spreadsheet"></i> <strong>Excel :</strong> Exporter le tableau d'inventaire.</div>
                    <div class="help-item"><i class="bi bi-file-earmark-pdf"></i> <strong>PDF :</strong> G√©n√©rer une capture du plan.</div>
                </div>

                <hr>

                <h3>‚å®Ô∏è Raccourcis Clavier</h3>
                <table class="shortcuts-table">
                    <tr><td><span class="key">Ctrl</span> + <span class="key">Z</span></td><td>Annuler la derni√®re action</td></tr>
                    <tr><td><span class="key">Ctrl</span> + <span class="key">Y</span></td><td>R√©tablir l'action annul√©e</td></tr>
                    <tr><td><span class="key">Ctrl</span> + <span class="key">C</span> / <span class="key">V</span></td><td>Copier / Coller un √©quipement</td></tr>
                    <tr><td><span class="key">Ctrl</span> + <span class="key">K</span></td><td>Recherche rapide (Spotlight)</td></tr>
                    <tr><td><span class="key">Suppr</span> ou <span class="key">Retour</span></td><td>Supprimer l'√©l√©ment s√©lectionn√©</td></tr>
                    <tr><td><span class="key">√âchap</span></td><td>Tout d√©s√©lectionner / Fermer les fen√™tres</td></tr>
                </table>

                <hr style="margin: 15px 0;">

                <h3>üñ±Ô∏è Raccourcis Souris</h3>
                <table class="shortcuts-table">
                    <tr><td><span class="key">Clic + Glisser</span></td><td>Se d√©placer sur le plan (Main)</td></tr>
                    <tr><td><span class="key">Double Clic</span> (Objet)</td><td>Modifier l'√©quipement ou la note</td></tr>
                    <tr><td><span class="key">Double Clic</span> (C√¢ble)</td><td>Ajouter/Modifier une √©tiquette texte</td></tr>
                    <tr><td><span class="key">Clic Droit</span> (Fond)</td><td>Menu rapide (Ajout √âquipement / Note)</td></tr>
                    <tr><td><span class="key">Clic Droit</span> (C√¢ble)</td><td>Menu du c√¢ble (Style, Auto-Alignement)</td></tr>
                    <tr><td><span class="key">Clic Droit</span> (Point bleu)</td><td>Supprimer un point d'angle sur un c√¢ble</td></tr>
                </table>
            </div>
            
            <div class="help-footer">
                <button class="action-btn" onclick="toggleHelp()">Compris !</button>
            </div>
        </div>
    </div>

    <div class="floating-ui trash-zone">
  <button class="fab-btn" id="photo-btn" onclick="triggerPhotoUpload()" title="Ajouter une photo">
    <i class="bi bi-camera"></i> </button>
</div>

<div class="floating-ui zoom-zone">
  <div class="floating-ui zoom-zone">
<button id="spotlight-btn-fixed" class="fab-btn" onclick="toggleSpotlight()" title="Rechercher (Ctrl+K)">
  <i class="bi bi-search"></i>
</button>
</div>
  <button class="fab-btn zoom-btn" onclick="updateZoom(0.1)" title="Zoom Avant">
    <i class="bi bi-plus-lg"></i> </button>
  
  <button class="fab-btn zoom-btn" onclick="resetZoom()" title="R√©initialiser la vue">
    <i class="bi bi-house"></i> </button>
  
  <button class="fab-btn zoom-btn" onclick="updateZoom(-0.1)" title="Zoom Arri√®re">
    <i class="bi bi-dash-lg"></i> </button>
</div>

    <div class="zoom-indicator" id="zoomIndicator">100%</div>
    <div class="position-indicator" id="positionIndicator">X: 0 | Y: 0</div>

    <div id="workspace-wrapper">
      <div id="workspace-container" onmousedown="handleWorkspaceMouseDown(event)">
        <svg id="connections-layer"></svg>
        <div id="selectionBox"></div>
      </div>
    </div>

    <div class="modal-overlay" id="addModal">
      <div class="modal-content">
        <h3 id="modalTitle">Nouvel √âquipement</h3>
        <div class="form-group">
          <label>Type d'appareil</label>
          <select id="newType" onchange="updateFormFields(this.value)">
            <option value="routeur">Routeur Mikrotik</option>
            <option value="switch">Switch</option>
            <option value="nvr">NVR</option>
            <option value="nxwitness">Serveur NX Witness</option>
            <option value="bullet">Cam√©ra Bullet</option>
            <option value="dome">Cam√©ra D√¥me</option>
            <option value="box">Box Internet</option>
            <option value="ecran">√âcran (PC)</option>
            <option value="radio">Pont Radio</option>
            <option value="ampli">Ampli Audio</option>
            <option value="pupitre">Pupitre Micro</option>
          </select>
        </div>

        <div class="form-group" id="radioModeGroup" style="display: none">
          <label>Mode</label>
          <select id="radioMode">
            <option value="couple">Couple PE/PR (Auto)</option>
            <option value="pe">√âmetteur (PE) seul</option>
            <option value="pr">R√©cepteur (PR) seul</option>
          </select>
        </div>

        <div class="form-group" id="radioCoupleQuantityGroup" style="display: none">
          <label>Nombre de couples</label>
          <select id="radioCoupleQuantity">
            <option value="1">1 couple</option>
            <option value="2">2 couples</option>
            <option value="3">3 couples</option>
            <option value="4">4 couples</option>
            <option value="5">5 couples</option>
          </select>
        </div>

        <div class="form-group" id="quantityGroup" style="display: none">
          <label>Quantit√©</label>
          <select id="newQuantity">
            <option value="1">1</option>
            <option value="2">2</option>
            <option value="3">3</option>
            <option value="4">4</option>
            <option value="5">5</option>
          </select>
        </div>

        <div class="form-group" id="hpGroup" style="display: none">
          <label>Haut-Parleurs</label>
          <select id="hpCount" onchange="updateHPFields()">
              <option value="1">1 HP</option>
              <option value="2">2 HP</option>
              <option value="3">3 HP</option>
              <option value="4">4 HP</option>
          </select>
          <div id="hpNamesContainer"></div>
        </div>

        <div class="form-group">
          <label>Nom / R√©f</label>
          <div id="nameFieldContainer">
            <input type="text" id="newDeviceName" placeholder="Ex: Switch-RDC" />
          </div>
        </div>

        <div class="form-group">
          <label>Adresse IP</label>
          <div id="ipFieldContainer">
            <input type="text" id="newIP" placeholder="Ex: 192.168.1.10" />
          </div>
        </div>

        <div class="form-group" id="locationPRGroup" style="display: none">
          <label>Localisation PR</label>
          <input type="text" id="newLocationPR" placeholder="Lieu Appareil" />
        </div>

        <div class="form-group" id="locationGroup">
          <label id="locationLabel">Localisation</label>
          <input type="text" id="newLocation" placeholder="Lieu Appareil" />
        </div>

        <div id="colorVuContainer" style="display: none; margin-top: 15px; background: #f8f9fa; padding: 10px; border-radius: 8px; border: 1px solid #ddd;">
            <label style="display: flex; align-items: center; gap: 10px; font-weight: bold; cursor: pointer; color: #333; margin: 0;">
                <input type="checkbox" id="isColorVu" style="width: 18px; height: 18px; cursor: pointer;">
                üåà Cam√©ra ColorVu
            </label>
        </div>

        <div class="form-group">
          <label>Connect√© √†</label>
          <select id="newParent"><option value="">-- Racine --</option></select>
        </div>
        
        <button id="modalActionBtn" class="btn-full btn-primary" onclick="addEquipment()">Ajouter</button>
        <button class="btn-full btn-cancel" onclick="closeAddModal()">Annuler</button>
      </div>
    </div>

    <div id="photo-modal-overlay">
      <img id="full-photo" src="" alt="Photo" />
      <div class="photo-controls">
        <button class="icon-btn" onclick="closePhotoViewer()">‚úï</button>
        <button class="icon-btn" onclick="deleteCurrentPhoto()" style="background: rgba(255, 59, 48, 0.6)">üóëÔ∏è</button>
      </div>
    </div>

    <div class="toast" id="toast"></div>

    <div id="connectionMenu" style="display: none; position: absolute; z-index: 500">
      <div style="background: white; border-radius: 12px; box-shadow: 0 4px 12px rgba(0,0,0,0.15); padding: 8px; min-width: 180px;">
        <div class="connection-option" onclick="setConnectionStyle('ethernet')" style="padding: 10px; cursor: pointer; display: flex; gap: 10px;">
          <span>üîµ</span> <span>Ethernet</span>
        </div>
        <div class="connection-option" onclick="setConnectionStyle('radio')" style="padding: 10px; cursor: pointer; display: flex; gap: 10px;">
          <span>üì°</span> <span>Radio</span>
        </div>
        <div class="connection-option" onclick="setConnectionStyle('fiber')" style="padding: 10px; cursor: pointer; display: flex; gap: 10px;">
          <span>üí°</span> <span>Fibre</span>
        </div>
        <hr style="margin: 8px 0; border-top: 1px solid #eee;">
        <div class="connection-option" onclick="reformatConnection()" style="padding: 10px; cursor: pointer; display: flex; gap: 10px; color: #34C759;">
          <span>‚ú®</span> <span>Mettre en forme</span>
        </div>
        <div class="connection-option" onclick="deleteConnection()" style="padding: 10px; cursor: pointer; display: flex; gap: 10px; color: #ff3b30;">
          <span>‚úÇÔ∏è</span> <span>Supprimer</span>
        </div>
      </div>
    </div>

    <div id="pointContextMenu" class="context-menu" style="display: none;">
      <div class="context-option" onclick="deleteControlPoint()">
        <i class="bi bi-x-circle" style="color: #ff3b30;"></i>
        <span>Supprimer ce point</span>
      </div>
    </div>

    <div id="workspaceContextMenu" class="context-menu">
      <div class="context-option" onclick="openAddModalFromContext()">
        <i class="bi bi-plus-lg"></i>
        <span>Ajouter un √©quipement</span>
      </div>

      <div class="context-option" onclick="addLabelFromContext()">
        <i class="bi bi-sticky"></i>
      <span>Ajouter une note</span>
  </div>
    </div>

    <div id="minimap">
    <div id="minimap-viewport"></div> 
    <div id="minimap-content"></div>  
    </div>

    <div id="spotlight-overlay" class="hidden" onclick="closeSpotlight(event)">
    <div class="spotlight-container">
        <div class="spotlight-header">
            <i class="bi bi-search search-icon"></i>
            <input type="text" id="spotlight-input" placeholder="Rechercher un √©quipement (Nom, IP, Type...)" autocomplete="off">
            <span class="shortcut-hint">ESC pour fermer</span>
        </div>
        <div id="spotlight-results">
            </div>
    </div>
    </div>

    <div id="bg-controls" class="floating-ui" style="display: none; top: 80px; left: 20px; bottom: auto; right: auto; padding: 10px; background: rgba(255,255,255,0.9); flex-direction: column; gap: 8px;">
        <div style="font-size: 12px; font-weight: bold; color: #333; text-align: center;">Opacit√© du Plan</div>
        <input type="range" id="bg-opacity-slider" min="0.1" max="1" step="0.05" value="0.5" oninput="updateBackgroundOpacity(this.value)" onchange="saveState()" style="width: 120px;">
        <button onclick="removeBackgroundImage()" style="background: #ff3b30; color: white; border: none; border-radius: 6px; padding: 5px; font-size: 12px; cursor: pointer;">
            <i class="bi bi-trash"></i> Supprimer plan
        </button>
    </div>

    <script src="script.js"></script>
  </body>
</html>